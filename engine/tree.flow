// tree.flow â€” OctoUI Widget Tree (Columnar Storage)
//
// Foundation module for the OctoUI rendering engine. Stores all widget
// data in parallel arrays (columnar layout) for cache-friendly iteration
// and future GPU upload.
//
// Widget types:
//   UI_BOX    = 1.0  (generic container/rectangle)
//   UI_TEXT   = 2.0  (text label)
//   UI_BUTTON = 3.0  (clickable button)
//   UI_ROW    = 4.0  (horizontal container)
//   UI_COLUMN = 5.0  (vertical container)

// -- Widget Type Constants --------------------------------------------------
let UI_BOX = 1.0
let UI_TEXT = 2.0
let UI_BUTTON = 3.0
let UI_ROW = 4.0
let UI_COLUMN = 5.0
let UI_CHECKBOX = 6.0
let UI_TEXTINPUT = 7.0
let UI_SLIDER = 8.0

// -- Focus State (shared across modules) ------------------------------------
let mut _ui_focus_id = -1.0

// -- Parallel Arrays (Widget Registry) --------------------------------------
// Every widget gets one entry at the same index across all arrays.

let mut _ui_types = []
let mut _ui_x = []
let mut _ui_y = []
let mut _ui_w = []
let mut _ui_h = []
let mut _ui_parent = []
let mut _ui_visible = []
let mut _ui_dirty = []
let mut _ui_state = []

// Per-widget RGB color (0-255 range)
let mut _ui_colors_r = []
let mut _ui_colors_g = []
let mut _ui_colors_b = []

// Text content and font index
let mut _ui_texts = []
let mut _ui_text_idx = []

// Container layout properties
let mut _ui_spacing = []
let mut _ui_padding = []

// -- Functions --------------------------------------------------------------

fn ui_tree_init()
  // Arrays are already initialized empty at module level.
  // Nothing to do.
  return 0.0
end

fn ui_tree_add(wtype, parent, w, h, text)
  // Capture the ID before any pushes (ID = current length)
  let id = len(_ui_types)

  // Type
  push(_ui_types, wtype)

  // Position (0,0 by default; layout pass sets these)
  push(_ui_x, 0.0)
  push(_ui_y, 0.0)

  // Size
  push(_ui_w, w)
  push(_ui_h, h)

  // Hierarchy
  push(_ui_parent, parent)

  // Visibility and dirty
  push(_ui_visible, 1.0)
  push(_ui_dirty, 1.0)

  // Interaction state (0=normal, 1=hovered, 2=pressed)
  push(_ui_state, 0.0)

  // Color (default black)
  push(_ui_colors_r, 0.0)
  push(_ui_colors_g, 0.0)
  push(_ui_colors_b, 0.0)

  // Text
  push(_ui_texts, text)
  push(_ui_text_idx, 0.0)

  // Container properties (spacing and padding)
  push(_ui_spacing, 0.0)
  push(_ui_padding, 0.0)

  return id
end

fn ui_tree_set_color(id, r, g, b)
  let i = int(id)
  _ui_colors_r[i] = r
  _ui_colors_g[i] = g
  _ui_colors_b[i] = b
  _ui_dirty[i] = 1.0
  return 0.0
end

fn ui_tree_set_text(id, text)
  let i = int(id)
  _ui_texts[i] = text
  _ui_dirty[i] = 1.0
  return 0.0
end

fn ui_tree_set_pos(id, x, y)
  let i = int(id)
  _ui_x[i] = x
  _ui_y[i] = y
  _ui_dirty[i] = 1.0
  return 0.0
end

fn ui_tree_set_size(id, w, h)
  let i = int(id)
  _ui_w[i] = w
  _ui_h[i] = h
  _ui_dirty[i] = 1.0
  return 0.0
end

fn ui_tree_set_spacing(id, spacing)
  let i = int(id)
  _ui_spacing[i] = spacing
  _ui_dirty[i] = 1.0
  return 0.0
end

fn ui_tree_set_padding(id, padding)
  let i = int(id)
  _ui_padding[i] = padding
  _ui_dirty[i] = 1.0
  return 0.0
end

fn ui_tree_count()
  return len(_ui_types)
end

fn ui_tree_is_container(id)
  let i = int(id)
  let wtype = _ui_types[i]
  if wtype == UI_ROW
    return 1.0
  end
  if wtype == UI_COLUMN
    return 1.0
  end
  return 0.0
end
