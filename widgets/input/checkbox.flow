// widgets/input/checkbox.flow â€” Checkbox Toggle Widget
//
// A clickable checkbox with checked/unchecked visual states.
// Rendered as a border-color box with a primary-color fill when checked.
//
// State: _ui_state[id] = 0.0 (unchecked) or 1.0 (checked)
// The checkbox also responds to hover (border brightens).

use "../../engine/tree"
use "../../engine/dirty"
use "../../themes/dark"

// Per-checkbox checked state tracking
let mut _ui_chk_checked = []

// Create a checkbox with a text label
// parent: parent widget ID
// label: text shown next to checkbox
// Returns: row widget ID (container for checkbox + label)
// The actual checkbox box is at returned_id + 1
fn ui_checkbox(parent, label)
  // Create a row to hold checkbox box + label
  let row = ui_tree_add(UI_ROW, parent, 0.0, 20.0, " ")
  let _rs = ui_tree_set_spacing(row, 8.0)

  // Checkbox box (16x16)
  let box_id = ui_tree_add(UI_CHECKBOX, row, 16.0, 16.0, " ")
  let _bc = ui_tree_set_color_themed(box_id, UI_COLOR_BORDER)

  // Label text
  let lbl = ui_tree_add(UI_TEXT, row, ui_text_width(label, 16.0), 16.0, label)
  let _tc = ui_tree_set_color_themed(lbl, UI_COLOR_TEXT)

  // Track checked state
  let needed = box_id + 1.0
  while len(_ui_chk_checked) < needed
    push(_ui_chk_checked, 0.0)
  end
  _ui_chk_checked[box_id] = 0.0

  return row
end

// Get checkbox box ID from the row container returned by ui_checkbox
fn ui_checkbox_box_id(row_id)
  return row_id + 1.0
end

// Check if checkbox is checked
// row_id: the ID returned by ui_checkbox()
fn ui_checkbox_checked(row_id)
  let box_id = row_id + 1.0
  if box_id < len(_ui_chk_checked)
    return _ui_chk_checked[box_id]
  end
  return 0.0
end

// Set checkbox checked state
fn ui_checkbox_set(row_id, checked)
  let box_id = row_id + 1.0
  let needed = box_id + 1.0
  while len(_ui_chk_checked) < needed
    push(_ui_chk_checked, 0.0)
  end
  _ui_chk_checked[box_id] = checked
  let _v = ui_checkbox_update_visual(box_id)
  let _d = ui_mark_dirty()
  return 0.0
end

// Toggle checkbox state (called by input system on click)
fn ui_checkbox_toggle(box_id)
  let needed = box_id + 1.0
  while len(_ui_chk_checked) < needed
    push(_ui_chk_checked, 0.0)
  end
  if _ui_chk_checked[box_id] == 0.0
    _ui_chk_checked[box_id] = 1.0
  else
    _ui_chk_checked[box_id] = 0.0
  end
  let _v = ui_checkbox_update_visual(box_id)
  let _d = ui_mark_dirty()
  return 0.0
end

// Update checkbox visual based on checked state
fn ui_checkbox_update_visual(box_id)
  let checked = _ui_chk_checked[box_id]
  if checked == 1.0
    // Checked: primary color fill
    let _s = ui_tree_set_color_themed(box_id, UI_COLOR_PRIMARY)
  else
    // Unchecked: border color (empty box)
    let _s = ui_tree_set_color_themed(box_id, UI_COLOR_BORDER)
  end
  return 0.0
end
