// examples/counter.flow — OctoUI Counter App (Phase 1 Acceptance Test)
//
// Interactive counter: click + / - buttons to change value.
// Demonstrates: reactive state, button clicks, text updates, GPU rendering.
//
// Run: octoflow run octoui/examples/counter.flow --allow-read --allow-write --allow-ffi --max-iters 1000000

use "../engine/tree"
use "../engine/layout"
use "../engine/pipeline"
use "../engine/dirty"
use "../themes/dark"
use "../widgets/core/box"
use "../widgets/core/text"
use "../widgets/input/button"
use "../widgets/layout/column"
use "../widgets/layout/row"
use "../state/reactive"
use "../platform/desktop/window_win32"
use "../platform/desktop/input"

// Open window
let _w = ui_window_open(400.0, 300.0, "OctoUI Counter")

// Create reactive state for counter value
let counter = ui_state(0.0)

// Build widget tree
let root = ui_column(-1.0, 10.0)
let _sp = ui_tree_set_padding(root, 40.0)
let _sr = ui_tree_set_pos(root, 0.0, 0.0)
let _ss = ui_tree_set_size(root, 400.0, 300.0)

// Title
let title = ui_text(root, "COUNTER", UI_COLOR_TEXT)

// Counter display — bound to reactive state
let display = ui_text(root, "0", UI_COLOR_PRIMARY)
let _bind = ui_bind_text(display, counter)

// Button row
let btn_row = ui_row(root, 20.0)

// Buttons
let btn_dec = ui_button(btn_row, 80.0, 40.0, " - ")
let btn_inc = ui_button(btn_row, 80.0, 40.0, " + ")

// Initial layout
let _l = ui_layout_update()

// Event loop
let mut running = 1.0
while running == 1.0
  // Poll window events (returns 0 on close)
  let alive = ui_poll_events()
  if alive == 0.0
    running = 0.0
  end

  // Escape to close
  if ui_key_pressed("escape") == 1.0
    running = 0.0
  end

  // Process input (hit testing, hover/press states)
  let _pi = ui_process_input()

  // Check button clicks
  if ui_button_clicked(btn_inc) == 1.0
    let val = ui_state_get(counter)
    let _s = ui_state_set(counter, val + 1.0)
  end
  if ui_button_clicked(btn_dec) == 1.0
    let val = ui_state_get(counter)
    let _s = ui_state_set(counter, val - 1.0)
  end

  // Render if dirty, otherwise sleep to save CPU
  if ui_is_dirty() == 1.0
    let _r = ui_pipeline_render()
    let _cd = ui_clear_dirty()
  else
    let _p = ui_pipeline_present()
    let _sl = sleep(16.0)
  end
end

// Cleanup
let _c = ui_window_close()
print("Counter example finished.")
